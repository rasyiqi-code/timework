// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Organization (Tenant)
model Organization {
  id        String   @id // Will match Stack Team ID
  name      String
  slug      String?  // Optional, for URLs/display
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members     OrganizationMember[]
  activeUsers User[]              // Users who currently have this Org selected
  projects    Project[]
  protocols Protocol[]
}

// User & Auth
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      String   @default("STAFF") // Enum: SUPER_ADMIN, ADMIN, MANAGER, STAFF
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  organizationId String? // Tracks "Currently Selected" Organization for session context
  organization   Organization? @relation(fields: [organizationId], references: [id])

  memberships OrganizationMember[] // Persistent membership across Orgs

  assignedItems ProjectItem[]
  managedProjects Project[]
  assignedProtocolItems ProtocolItem[]
}

// Membership (Many-to-Many with Metadata)
model OrganizationMember {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  role           String       @default("STAFF") // Role specific to this Org (ADMIN, STAFF)
  joinedAt       DateTime     @default(now())

  @@unique([userId, organizationId]) // User can join an Org only once
  @@index([organizationId])
  @@index([userId])
}

// Project (The Canvas)
model Project {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("ACTIVE") // Enum: ACTIVE, COMPLETED, ARCHIVED
  category    String   @default("SPT")    // Enum: SPT, SATUAN
  startDate   DateTime?
  targetDate  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  items       ProjectItem[]
  history     ProjectHistory[]
  
  // Flexible SaaS Data (Custom Fields per Organization)
  metadata    Json? 

  @@index([organizationId])
  @@index([createdById])
}

// Protocol (Template)
model Protocol {
  id          String   @id @default(cuid())
  name        String
  description String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  items       ProtocolItem[]

  @@index([organizationId])
}

// Protocol Items (Template Tasks)
model ProtocolItem {
  id          String   @id @default(cuid())
  title       String
  description String?
  role        String?    @default("STAFF") 
  duration    Int      @default(1) // Default duration in days
  order       Int      @default(0)
  
  protocolId  String
  protocol    Protocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)

  defaultAssigneeId String?
  defaultAssignee   User?   @relation(fields: [defaultAssigneeId], references: [id])

  // Dependencies within template (Adjacency List)
  dependsOn   ProtocolDependency[] @relation("Dependent")
  requiredBy  ProtocolDependency[] @relation("Prerequisite")
}

model ProtocolDependency {
  id             String       @id @default(cuid())
  itemId         String
  item           ProtocolItem @relation("Dependent", fields: [itemId], references: [id], onDelete: Cascade)
  
  prerequisiteId String
  prerequisite   ProtocolItem @relation("Prerequisite", fields: [prerequisiteId], references: [id], onDelete: Cascade)

  @@unique([itemId, prerequisiteId])
}

// Project Items (Real Tasks)
model ProjectItem {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("LOCKED") // Enum: LOCKED, OPEN, IN_PROGRESS, DONE, PROBLEM
  
  // Timeline Data
  startDate   DateTime?
  endDate     DateTime?
  
  projectId   String
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])

  // Dependency Graph
  dependsOn   ItemDependency[] @relation("Dependent")
  requiredBy  ItemDependency[] @relation("Prerequisite")

  // For tracking which protocol item this came from (optional)
  originProtocolItemId String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([assignedToId])
}

model ItemDependency {
  id             String      @id @default(cuid())
  itemId         String
  item           ProjectItem @relation("Dependent", fields: [itemId], references: [id], onDelete: Cascade)
  
  prerequisiteId String
  prerequisite   ProjectItem @relation("Prerequisite", fields: [prerequisiteId], references: [id], onDelete: Cascade)

  @@unique([itemId, prerequisiteId])
}

// Audit Log / History
model ProjectHistory {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  action    String   // e.g., "ITEM_ADDED", "STATUS_CHANGE"
  details   String?  // JSON string of details
  
  timestamp DateTime @default(now())
}
